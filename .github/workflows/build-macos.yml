name: Build Aseprite for macOS ARM64

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly builds on Sunday

jobs:
  build:
    runs-on: macos-latest  # Currently macos-14 (ARM64)
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0  # Fetch all history and tags
    
    - name: Get latest stable release
      id: version
      run: |
        # Fetch all tags
        git fetch --tags
        
        # Get latest stable tag (exclude beta, rc, dev)
        LATEST_TAG=$(git tag -l 'v*' | grep -v -E '(beta|rc|dev)' | sort -V | tail -n1)
        
        if [ -z "$LATEST_TAG" ]; then
          echo "No stable release tag found, using main branch"
          VERSION=$(git describe --tags --always)
        else
          echo "Found latest stable release: $LATEST_TAG"
          git checkout $LATEST_TAG
          git submodule update --init --recursive
          VERSION=$LATEST_TAG
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building Aseprite $VERSION"
    
    - name: Install Skia
      shell: bash
      run: |
        skia_url=$(source ${{ github.workspace }}/laf/misc/skia-url.sh | xargs)
        skia_file=$(basename $skia_url)
        echo "Downloading Skia from: $skia_url"
        curl --ssl-revoke-best-effort -L -o "$skia_file" "$skia_url"
        unzip "$skia_file" -d skia
    
    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2.17
      with:
        key: macos-arm64-gui-lua-release
    
    - uses: aseprite/get-ninja@main
    
    - name: Generate Makefiles
      shell: bash
      run: |
        cmake -S . -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DENABLE_TESTS=OFF \
          -DENABLE_SCRIPTING=ON \
          -DENABLE_CCACHE=ON \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR=$(realpath skia) \
          -DSKIA_LIBRARY_DIR=$(realpath skia/out/Release-arm64)
    
    - name: Compile
      shell: bash
      run: |
        cd build && ninja aseprite
    
    - name: Show build output
      run: |
        ls -lah build/bin/
    
    - name: Create ZIP archive
      run: |
        cd build/bin
        zip -r "../../Aseprite-${{ steps.version.outputs.version }}-macOS-arm64.zip" Aseprite.app
    
    - name: Create DMG
      run: |
        cd build/bin
        mkdir -p dmg
        cp -r Aseprite.app dmg/
        hdiutil create -volname "Aseprite ${{ steps.version.outputs.version }}" \
          -srcfolder dmg \
          -ov -format UDZO \
          "../../Aseprite-${{ steps.version.outputs.version }}-macOS-arm64.dmg"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Aseprite-macOS-arm64
        path: |
          Aseprite-*.zip
          Aseprite-*.dmg
        retention-days: 90
    
    - name: Create Release (optional)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Aseprite ${{ steps.version.outputs.version }} - macOS ARM64
        body: |
          Automated build of Aseprite for macOS ARM64 (Apple Silicon)
          
          **Downloads:**
          - `Aseprite-*.zip` - Portable app bundle
          - `Aseprite-*.dmg` - Disk image installer
          
          **Note:** This is an unlicensed build for personal use. 
          Please support the developer at https://www.aseprite.org/store
          
          Build date: ${{ github.event.repository.updated_at }}
        files: |
          Aseprite-*.zip
          Aseprite-*.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
